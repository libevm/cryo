use crate::*;
use ethers::abi::{decode, ParamType};
use ethers::prelude::*;
use ethers::utils::hex;
use ethers_core::utils::format_ether;
use polars::prelude::*;
use std::collections::HashMap;

// https://github.com/libevm/eth_call_abuser
const PRICE_QUERY_CALLDATA: &str = "608060405234801561001057600080fd5b50600061004b7388e6a0c2ddd26feeb64f039a2c41296fcb3f564073c02aaa39b223fe8d0a0e5c4f27ead9083c756cc261016860201b60201c565b610083734e68ccd3e89f51c3074ca5072bbac773960dfa3673c02aaa39b223fe8d0a0e5c4f27ead9083c756cc261016860201b60201c565b6100bb7360594a405d53811d3bc4766596efd80fd545a27073c02aaa39b223fe8d0a0e5c4f27ead9083c756cc261016860201b60201c565b6100f373cbcdf9626bc03e24f779434178a73a0b4bad62ed73c02aaa39b223fe8d0a0e5c4f27ead9083c756cc261016860201b60201c565b610134733fd4cf9303c4bc9e13772618828712c8eac7dd2f73c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2670de0b6b3a764000061050d60201b60201c565b6040516020016101489594939291906109fc565b604051602081830303815290604052905060008190506020810180590381f35b60006101798361087560201b60201c565b6101865760019050610507565b600083905060008173ffffffffffffffffffffffffffffffffffffffff16633850c7bd6040518163ffffffff1660e01b815260040160e060405180830381865afa1580156101d8573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906101fc9190610b84565b50505050505090506401000276a473ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16111580610284575073fffd8963efd1fc6a506488495d951d5263988d2573ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1610155b1561029457600192505050610507565b60008273ffffffffffffffffffffffffffffffffffffffff16630dfe16816040518163ffffffff1660e01b8152600401602060405180830381865afa1580156102e1573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103059190610c64565b905060008373ffffffffffffffffffffffffffffffffffffffff1663d21220a76040518163ffffffff1660e01b8152600401602060405180830381865afa158015610354573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103789190610c64565b905060008273ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103c7573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103eb9190610cbd565b905060008273ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa15801561043a573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061045e9190610cbd565b90506000610472868461088860201b60201c565b90508873ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff16036104d9578160126104b49190610d19565b600a6104c09190610e80565b816104cb9190610ecb565b975050505050505050610507565b808260126104e79190610f0d565b600a6104f39190610e80565b6104fd9190610f70565b9750505050505050505b92915050565b600061051e8461087560201b60201c565b61052b576001905061086e565b600084905060008173ffffffffffffffffffffffffffffffffffffffff16630dfe16816040518163ffffffff1660e01b8152600401602060405180830381865afa15801561057d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105a19190610c64565b905060008273ffffffffffffffffffffffffffffffffffffffff1663d21220a76040518163ffffffff1660e01b8152600401602060405180830381865afa1580156105f0573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106149190610c64565b90506000808473ffffffffffffffffffffffffffffffffffffffff16630902f1ac6040518163ffffffff1660e01b8152600401606060405180830381865afa158015610664573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106889190611023565b506dffffffffffffffffffffffffffff1691506dffffffffffffffffffffffffffff16915060008473ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa1580156106fa573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061071e9190610cbd565b905060008473ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa15801561076d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107919190610cbd565b90508473ffffffffffffffffffffffffffffffffffffffff168a73ffffffffffffffffffffffffffffffffffffffff160361081c5780600a6107d39190610e80565b846107de9190610ecb565b935081600a6107ed9190610e80565b83858b6107fa9190610ecb565b6108049190610f70565b61080e9190610f70565b97505050505050505061086e565b81600a6108299190610e80565b836108349190610ecb565b925080600a6108439190610e80565b84848b6108509190610ecb565b61085a9190610f70565b6108649190610f70565b9750505050505050505b9392505050565b600080823b905060008111915050919050565b6000808373ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff166108c39190610ecb565b9050600083600a6108d49190611076565b90506109008282780100000000000000000000000000000000000000000000000061090a60201b60201c565b9250505092915050565b6000806000801985870985870292508281108382030391505060008103610944576000841161093857600080fd5b838204925050506109dc565b80841161095057600080fd5b600084868809905082811182039150808303925060008586600003169050808604955080840493506001818260000304019050808302841793506000600287600302189050808702600203810290508087026002038102905080870260020381029050808702600203810290508087026002038102905080870260020381029050808502955050505050505b9392505050565b6000819050919050565b6109f6816109e3565b82525050565b600060a082019050610a1160008301886109ed565b610a1e60208301876109ed565b610a2b60408301866109ed565b610a3860608301856109ed565b610a4560808301846109ed565b9695505050505050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b610a7d81610a54565b8114610a8857600080fd5b50565b600081519050610a9a81610a74565b92915050565b60008160020b9050919050565b610ab681610aa0565b8114610ac157600080fd5b50565b600081519050610ad381610aad565b92915050565b600061ffff82169050919050565b610af081610ad9565b8114610afb57600080fd5b50565b600081519050610b0d81610ae7565b92915050565b600060ff82169050919050565b610b2981610b13565b8114610b3457600080fd5b50565b600081519050610b4681610b20565b92915050565b60008115159050919050565b610b6181610b4c565b8114610b6c57600080fd5b50565b600081519050610b7e81610b58565b92915050565b600080600080600080600060e0888a031215610ba357610ba2610a4f565b5b6000610bb18a828b01610a8b565b9750506020610bc28a828b01610ac4565b9650506040610bd38a828b01610afe565b9550506060610be48a828b01610afe565b9450506080610bf58a828b01610afe565b93505060a0610c068a828b01610b37565b92505060c0610c178a828b01610b6f565b91505092959891949750929550565b6000610c3182610a54565b9050919050565b610c4181610c26565b8114610c4c57600080fd5b50565b600081519050610c5e81610c38565b92915050565b600060208284031215610c7a57610c79610a4f565b5b6000610c8884828501610c4f565b91505092915050565b610c9a816109e3565b8114610ca557600080fd5b50565b600081519050610cb781610c91565b92915050565b600060208284031215610cd357610cd2610a4f565b5b6000610ce184828501610ca8565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610d24826109e3565b9150610d2f836109e3565b9250828203905081811115610d4757610d46610cea565b5b92915050565b60008160011c9050919050565b6000808291508390505b6001851115610da457808604811115610d8057610d7f610cea565b5b6001851615610d8f5780820291505b8081029050610d9d85610d4d565b9450610d64565b94509492505050565b600082610dbd5760019050610e79565b81610dcb5760009050610e79565b8160018114610de15760028114610deb57610e1a565b6001915050610e79565b60ff841115610dfd57610dfc610cea565b5b8360020a915084821115610e1457610e13610cea565b5b50610e79565b5060208310610133831016604e8410600b8410161715610e4f5782820a905083811115610e4a57610e49610cea565b5b610e79565b610e5c8484846001610d5a565b92509050818404811115610e7357610e72610cea565b5b81810290505b9392505050565b6000610e8b826109e3565b9150610e96836109e3565b9250610ec37fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8484610dad565b905092915050565b6000610ed6826109e3565b9150610ee1836109e3565b9250828202610eef816109e3565b91508282048414831517610f0657610f05610cea565b5b5092915050565b6000610f18826109e3565b9150610f23836109e3565b9250828201905080821115610f3b57610f3a610cea565b5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000610f7b826109e3565b9150610f86836109e3565b925082610f9657610f95610f41565b5b828204905092915050565b60006dffffffffffffffffffffffffffff82169050919050565b610fc481610fa1565b8114610fcf57600080fd5b50565b600081519050610fe181610fbb565b92915050565b600063ffffffff82169050919050565b61100081610fe7565b811461100b57600080fd5b50565b60008151905061101d81610ff7565b92915050565b60008060006060848603121561103c5761103b610a4f565b5b600061104a86828701610fd2565b935050602061105b86828701610fd2565b925050604061106c8682870161100e565b9150509250925092565b6000611081826109e3565b915061108c83610b13565b92506110b97fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8484610dad565b90509291505056fe";

/// Columns for prices
#[cryo_to_df::to_df(Datatype::Prices)]
#[derive(Default)]
pub struct Prices {
    n_rows: usize,

    block_number: Vec<u32>,

    weth_usdc: Vec<f64>,
    weth_usdt: Vec<f64>,
    weth_dai: Vec<f64>,
    weth_wbtc: Vec<f64>,
    weth_bnt: Vec<f64>,

    chain_id: Vec<u64>,
}

#[async_trait::async_trait]
impl Dataset for Prices {
    fn name() -> &'static str {
        "prices"
    }

    fn default_sort() -> Vec<String> {
        vec!["block_number".to_string()]
    }

    fn default_blocks() -> Option<String> {
        Some("latest".to_string())
    }
}

type Result<T> = ::core::result::Result<T, CollectError>;
type BlockPrices = (u32, Vec<f64>);

#[async_trait::async_trait]
impl CollectByBlock for Prices {
    type Response = BlockPrices;

    async fn extract(
        request: Params,
        source: Arc<Source>,
        _schemas: Schemas,
    ) -> Result<Self::Response> {
        let block_number = request.block_number()? as u32;

        let call_data: Vec<u8> = hex::decode(PRICE_QUERY_CALLDATA).unwrap();
        let transaction =
            TransactionRequest { data: Some(call_data.clone().into()), ..Default::default() };

        let output = source.fetcher.call(transaction, block_number.into()).await?;
        let resp: Vec<f64> = decode(
            &[
                ParamType::Uint(256),
                ParamType::Uint(256),
                ParamType::Uint(256),
                ParamType::Uint(256),
                ParamType::Uint(256),
            ],
            &output,
        )
        .unwrap()
        .iter()
        .map(|x| format_ether(x.clone().into_uint().unwrap()).parse::<f64>().unwrap())
        .collect();

        Ok((block_number, resp))
    }

    fn transform(response: Self::Response, columns: &mut Self, schemas: &Schemas) -> Result<()> {
        let schema = schemas.get(&Datatype::Prices).ok_or(err("schema not provided"))?;
        process_prices(columns, response, schema)
    }
}

#[async_trait::async_trait]
impl CollectByTransaction for Prices {
    type Response = ();
}

fn process_prices(columns: &mut Prices, data: BlockPrices, schema: &Table) -> Result<()> {
    let (block, prices) = data;
    columns.n_rows += 1;
    store!(schema, columns, block_number, block);
    store!(schema, columns, weth_usdc, prices[0]);
    store!(schema, columns, weth_usdt, prices[1]);
    store!(schema, columns, weth_dai, prices[2]);
    store!(schema, columns, weth_wbtc, prices[3]);
    store!(schema, columns, weth_bnt, prices[4]);

    Ok(())
}